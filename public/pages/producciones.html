<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Gestión de Producciones</title>
		<link rel="stylesheet" href="../css/styles.css" />
		<link rel="stylesheet" href="../css/variables.css">
		<link rel="stylesheet" href="../css/sidebar.css">
		<style>
			.btn--small {
				padding: 0.3rem 0.6rem;
				font-size: 0.8rem;
				margin-top: 0.5rem;
			}
			.form__help {
				font-size: 0.75rem;
				color: #666;
				margin-top: 0.25rem;
				display: block;
			}
			.form__group select[multiple] {
				min-height: 100px;
			}
			.action-btn--insumo {
				background-color: #ff9800;
				color: white;
			}
			.action-btn--insumo:hover {
				background-color: #f57c00;
			}
		</style>
		<script src="../components/sidebar.js"></script>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<!-- Export Libraries -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
		<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
		<script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.js"></script>
		<!-- Utils -->
		<script src="../js/exportUtils.js"></script>
	</head>
	<body>
		<!-- Sidebar (menu lateral) -->
		<div id="sidebar-container"></div>
		<main>
			<div class="section">
				<div class="section__header">
					<h2 class="section__title" id="sidebar-trigger">
						<img class="section__image-slider" src="../img/menu-production.png" id="sidebar-img-trigger">Gestión de Producciones
					</h2>
					<div class="section__actions">
						<button id="newProduccionBtn" class="btn btn--primary">
							Nueva Producción
						</button>
						<button id="generateReportBtn" class="btn btn--secondary">
							Generar Reporte
						</button>
					</div>
				</div>

				<div class="filter-section">
					<div class="filter-form">
						<div class="form__group">
							<input
								type="text"
								id="searchInput"
								class="form__input"
								placeholder="Buscar por nombre o ID..."
							/>
						</div>
						<div class="form__group">
							<select id="filterStatus" class="form__select">
								<option value="">Todos los estados</option>
								<option value="activo">Activo</option>
								<option value="inactivo">Inactivo</option>
							</select>
						</div>
						<div class="form__group">
							<select id="filterCultivo" class="form__select">
								<option value="">Todos los cultivos</option>
							</select>
						</div>
						<div class="form__group">
							<select id="filterCiclo" class="form__select">
								<option value="">Todos los ciclos</option>
							</select>
						</div>
						<div class="form__group">
							<label for="filterDateFrom" class="form__label">Desde</label>
							<input type="date" id="filterDateFrom" class="form__input" />
						</div>
						<div class="form__group">
							<label for="filterDateTo" class="form__label">Hasta</label>
							<input type="date" id="filterDateTo" class="form__input" />
						</div>
						<button id="applyFilterBtn" class="btn btn--primary">
							Aplicar Filtros
						</button>
						<button id="resetFilterBtn" class="btn">Restablecer</button>
					</div>
				</div>

				<div id="produccionesList" class="data-container">
					<table class="table">
						<thead class="table__header">
							<tr>
								<th>Identificador</th>
								<th>Nombre</th>
								<th>Responsable</th>
								<th>Cultivo</th>
								<th>Ciclo</th>
								<th>Fecha Inicio</th>
								<th>Fecha Fin</th>
								<th>Estado</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody id="produccionesTableBody">
							<!-- Los datos de producciones se cargarán aquí dinámicamente -->
						</tbody>
					</table>
				</div>

				<div id="pagination" class="pagination">
					<!-- La paginación se generará dinámicamente -->
				</div>
			</div>

			<!-- Modal para crear/editar producción -->
			<div id="produccionModal" class="modal">
				<div class="modal__content">
					<div class="modal__header">
						<h3 id="modalTitle" class="modal__title">Nueva Producción</h3>
						<span class="modal__close">&times;</span>
					</div>
					<div class="modal__body">
						<form id="produccionForm" class="form form--grid">
							<div class="form__row">
								<div class="form__group">
									<label for="identificador" class="form__label">Identificador de Producción *</label>
									<input type="text" id="identificador" name="identificador" class="form__input" readonly />
									<small class="form__help">Se genera automáticamente</small>
								</div>
								<div class="form__group">
									<label for="responsable" class="form__label">Responsable *</label>
									<select id="responsable" name="responsable" class="form__select" required>
										<option value="">Seleccione un responsable</option>
									</select>
									<button type="button" id="addResponsableBtn" class="btn btn--secondary btn--small">+ Agregar Usuario</button>
								</div>
							</div>
							<div class="form__row">
								<div class="form__group">
									<label for="nombre" class="form__label">Nombre de Producción *</label>
									<input type="text" id="nombre" name="nombre" class="form__input" required minlength="3" maxlength="100" />
									<small class="form__help">Mínimo 3, máximo 100 caracteres. Debe contener al menos una letra.</small>
								</div>
								<div class="form__group">
									<label for="cultivo" class="form__label">Cultivo *</label>
									<select id="cultivo" name="cultivo" class="form__select" required>
										<option value="">Seleccione un cultivo</option>
									</select>
									<button type="button" id="addCultivoBtn" class="btn btn--secondary btn--small">+ Agregar Cultivo</button>
								</div>
							</div>
							<div class="form__row">
								<div class="form__group">
									<label for="ciclo_cultivo" class="form__label">Ciclo de Cultivo *</label>
									<select id="ciclo_cultivo" name="ciclo_cultivo" class="form__select" required>
										<option value="">Seleccione un ciclo</option>
									</select>
									<button type="button" id="addCicloBtn" class="btn btn--secondary btn--small">+ Agregar Ciclo</button>
								</div>
								<div class="form__group">
									<label for="sensores" class="form__label">Sensores * (Máx. 3)</label>
									<select id="sensores" name="sensores" class="form__select" multiple required>
										<option value="">Seleccione sensores</option>
									</select>
									<button type="button" id="addSensorBtn" class="btn btn--secondary btn--small">+ Agregar Sensor</button>
								</div>
							</div>
							<div class="form__row">
								<div class="form__group">
									<label for="insumos" class="form__label">Insumos *</label>
									<select id="insumos" name="insumos" class="form__select" multiple required>
										<option value="">Seleccione insumos</option>
									</select>
									<button type="button" id="addInsumoBtn" class="btn btn--secondary btn--small">+ Agregar Insumo</button>
								</div>
								<div class="form__group">
									<label for="fecha_inicio" class="form__label">Fecha de Inicio *</label>
									<input type="date" id="fecha_inicio" name="fecha_inicio" class="form__input" required />
								</div>
							</div>
							<div class="form__row">
								<div class="form__group">
									<label for="fecha_fin" class="form__label">Fecha de Fin Estimada *</label>
									<input type="date" id="fecha_fin" name="fecha_fin" class="form__input" required />
								</div>
								<div class="form__group">
									<label for="estado" class="form__label">Estado</label>
									<select id="estado" name="estado" class="form__select">
										<option value="activo">Activo</option>
										<option value="inactivo">Inactivo</option>
									</select>
								</div>
							</div>
							<div class="form__row form__row--full">
								<div class="form__group">
									<label for="descripcion" class="form__label">Descripción</label>
									<textarea id="descripcion" name="descripcion" class="form__textarea"></textarea>
								</div>
							</div>
							<div class="form__actions">
								<button type="button" class="btn modal__cancel">Cancelar</button>
								<button type="button" id="saveDraftBtn" class="btn btn--secondary">Guardar Borrador</button>
								<button type="submit" id="saveProduccionBtn" class="btn btn--primary" disabled>Crear Producción</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- Modal para visualizar producción -->
			<div id="viewProduccionModal" class="modal">
				<div class="modal__content">
					<div class="modal__header">
						<h3 class="modal__title">Detalles de la Producción</h3>
						<span class="modal__close">&times;</span>
					</div>
					<div class="modal__body" id="produccionDetails">
						<!-- Los detalles de la producción se cargarán aquí dinámicamente -->
					</div>
				</div>
			</div>

			<!-- Modal para uso de insumos -->
			<div id="usoInsumoModal" class="modal">
				<div class="modal__content">
					<div class="modal__header">
						<h3 class="modal__title">Registrar Uso de Insumo</h3>
						<span class="modal__close">&times;</span>
					</div>
					<div class="modal__body">
						<form id="usoInsumoForm" class="form form--grid">
							<div class="form__row">
								<div class="form__group">
									<label for="insumo_uso" class="form__label">Insumo *</label>
									<select id="insumo_uso" name="insumo_uso" class="form__select" required>
										<option value="">Seleccione un insumo</option>
									</select>
								</div>
								<div class="form__group">
									<label for="fecha_uso" class="form__label">Fecha de Uso *</label>
									<input type="date" id="fecha_uso" name="fecha_uso" class="form__input" required />
								</div>
							</div>
							<div class="form__row">
								<div class="form__group">
									<label for="cantidad_uso" class="form__label">Cantidad *</label>
									<input type="number" id="cantidad_uso" name="cantidad_uso" class="form__input" required />
								</div>
								<div class="form__group">
									<label for="responsable_uso" class="form__label">Responsable *</label>
									<select id="responsable_uso" name="responsable_uso" class="form__select" required>
										<option value="">Seleccione responsable</option>
									</select>
								</div>
							</div>
							<div class="form__row">
								<div class="form__group">
									<label for="valor_unitario_uso" class="form__label">Valor Unitario *</label>
									<input type="number" id="valor_unitario_uso" name="valor_unitario_uso" class="form__input" required />
								</div>
								<div class="form__group">
									<label for="valor_total_uso" class="form__label">Valor Total *</label>
									<input type="number" id="valor_total_uso" name="valor_total_uso" class="form__input" required />
								</div>
							</div>
							<div class="form__row form__row--full">
								<div class="form__group">
									<label for="observaciones_uso" class="form__label">Observaciones</label>
									<textarea id="observaciones_uso" name="observaciones_uso" class="form__textarea"></textarea>
								</div>
							</div>
							<div class="form__actions">
								<button type="button" class="btn modal__cancel">Cancelar</button>
								<button type="submit" class="btn btn--primary">Guardar Uso</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- Modal para reportes de producción -->
			<div id="produccionReportModal" class="modal">
				<div class="modal__content modal__content--large">
					<div class="modal__header">
						<h3 class="modal__title">Reporte de Producciones</h3>
						<span class="modal__close">&times;</span>
					</div>
					<div class="modal__body">
						<div class="report-filters">
							<div class="form__group">
								<label for="reportStatusSelect" class="form__label">Filtrar por Estado</label>
								<select id="reportStatusSelect" class="form__select">
									<option value="">Todos los estados</option>
									<option value="activo">Activo</option>
									<option value="inactivo">Inactivo</option>
								</select>
							</div>
							<div class="form__group">
								<label for="reportCultivoSelect" class="form__label">Filtrar por Cultivo</label>
								<select id="reportCultivoSelect" class="form__select">
									<option value="">Todos los cultivos</option>
								</select>
							</div>
							<div class="form__group">
								<label for="reportCicloSelect" class="form__label">Filtrar por Ciclo</label>
								<select id="reportCicloSelect" class="form__select">
									<option value="">Todos los ciclos</option>
								</select>
							</div>
							<button id="generateReportDataBtn" class="btn btn--primary">
								Generar Reporte
							</button>
						</div>

						<div class="report-content">
							<div class="report-summary">
								<h4>Resumen</h4>
								<p>Total Producciones: <span id="totalProducciones">0</span></p>
								<p>Producciones Activas: <span id="produccionesActivas">0</span></p>
								<p>Producciones Inactivas: <span id="produccionesInactivas">0</span></p>
								<p>Total Inversión: <span id="totalInversion">$0</span></p>
								<p>Total Meta: <span id="totalMeta">$0</span></p>
							</div>

							<div class="report-actions">
								<button id="exportExcelBtn" class="btn btn--secondary">
									Exportar a Excel
								</button>
								<button id="exportPdfBtn" class="btn btn--secondary">
									Exportar a PDF
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>

		<script>
			// API Configuration and Utils
			const API_BASE_URL = "http://localhost:3000/api";
			const API_ENDPOINTS = {
				producciones: `${API_BASE_URL}/producciones`,
				usuarios: `${API_BASE_URL}/usuarios`,
				cultivos: `${API_BASE_URL}/cultivos`,
				ciclos: `${API_BASE_URL}/ciclos`,
				sensores: `${API_BASE_URL}/sensores`,
				insumos: `${API_BASE_URL}/insumos`,
				usoInsumos: `${API_BASE_URL}/uso-insumos`,
			};

			// Utility function to make API requests
			async function apiRequest(url, options = {}) {
				try {
					const defaultOptions = {
						headers: {
							"Content-Type": "application/json",
							Accept: "application/json",
						},
						credentials: "same-origin",
						mode: "cors",
					};

					const response = await fetch(url, { ...defaultOptions, ...options });

					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}

					return await response.json();
				} catch (error) {
					console.error("API Request Error:", error);
					throw error;
				}
			}

			// Global state
			let currentProduccion = null;
			let currentProduccionId = null;
			let isLoading = false;
			let currentPage = 1;
			const itemsPerPage = 10;
			let filteredProducciones = [];
			let reportData = [];

			// Utility Functions
			function formatDate(dateString) {
				if (!dateString) return "";
				return new Date(dateString).toLocaleDateString("es-ES");
			}

			function closeModal(modal) {
				modal.classList.remove("modal--open");
			}

			// Generar identificador automático de producción
			function generateProduccionId() {
				const now = new Date();
				const day = String(now.getDate()).padStart(2, '0');
				const month = String(now.getMonth() + 1).padStart(2, '0');
				const year = now.getFullYear();
				const sequence = String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0');
				return `PROD-${day}${month}${year}-${sequence}`;
			}

			// Validar nombre de producción
			function validateProduccionName(name) {
				if (!name || name.length < 3 || name.length > 100) return false;
				// Debe contener al menos una letra
				return /[a-zA-Z]/.test(name);
			}

			// Estado global y funciones principales
			async function getProducciones() {
				return apiRequest(API_ENDPOINTS.producciones);
			}

			// Cargar datos para los selectores
			async function loadSelectorsData() {
				try {
					// Cargar usuarios
					const usuarios = await apiRequest(API_ENDPOINTS.usuarios);
					const responsableSelect = document.getElementById('responsable');
					const responsableUsoSelect = document.getElementById('responsable_uso');
					
					usuarios.forEach(usuario => {
						if (usuario.estado === 'activo') {
							const option = new Option(usuario.nombre, usuario.id);
							responsableSelect.add(option.cloneNode(true));
							responsableUsoSelect.add(option);
						}
					});

					// Cargar cultivos
					const cultivos = await apiRequest(API_ENDPOINTS.cultivos);
					const cultivoSelect = document.getElementById('cultivo');
					const filterCultivoSelect = document.getElementById('filterCultivo');
					const reportCultivoSelect = document.getElementById('reportCultivoSelect');
					
					cultivos.forEach(cultivo => {
						if (cultivo.estado === 'activo') {
							const option = new Option(cultivo.nombre, cultivo.id);
							cultivoSelect.add(option.cloneNode(true));
							filterCultivoSelect.add(option.cloneNode(true));
							reportCultivoSelect.add(option);
						}
					});

					// Cargar ciclos
					const ciclos = await apiRequest(API_ENDPOINTS.ciclos);
					const cicloSelect = document.getElementById('ciclo_cultivo');
					const filterCicloSelect = document.getElementById('filterCiclo');
					const reportCicloSelect = document.getElementById('reportCicloSelect');
					
					ciclos.forEach(ciclo => {
						if (ciclo.estado === 'activo') {
							const option = new Option(ciclo.nombre, ciclo.id);
							cicloSelect.add(option.cloneNode(true));
							filterCicloSelect.add(option.cloneNode(true));
							reportCicloSelect.add(option);
						}
					});

					// Cargar sensores
					const sensores = await apiRequest(API_ENDPOINTS.sensores);
					const sensoresSelect = document.getElementById('sensores');
					
					sensores.forEach(sensor => {
						if (sensor.estado === 'activo') {
							const option = new Option(sensor.nombre, sensor.id);
							sensoresSelect.add(option);
						}
					});

					// Cargar insumos
					const insumos = await apiRequest(API_ENDPOINTS.insumos);
					const insumosSelect = document.getElementById('insumos');
					const insumoUsoSelect = document.getElementById('insumo_uso');
					
					insumos.forEach(insumo => {
						if (insumo.estado === 'activo') {
							const option = new Option(insumo.nombre, insumo.id);
							insumosSelect.add(option.cloneNode(true));
							insumoUsoSelect.add(option);
						}
					});

				} catch (error) {
					console.error('Error loading selectors data:', error);
					showAlert('Error al cargar datos de los selectores', 'error');
				}
			}

			async function createProduccion(produccionData) {
				// Validar campos obligatorios
				if (!produccionData.nombre || !produccionData.responsable || !produccionData.cultivo || 
					!produccionData.ciclo_cultivo || !produccionData.sensores || !produccionData.insumos) {
					throw new Error('Todos los campos obligatorios deben estar completos');
				}

				// Validar nombre de producción
				if (!validateProduccionName(produccionData.nombre)) {
					throw new Error('El nombre de producción debe tener entre 3 y 100 caracteres y contener al menos una letra');
				}

				// Validar sensores (máximo 3)
				if (produccionData.sensores.length > 3) {
					throw new Error('Se pueden seleccionar máximo 3 sensores');
				}

				// Validar fechas
				const fechaInicio = new Date(produccionData.fecha_inicio);
				const fechaFin = new Date(produccionData.fecha_fin);
				if (fechaFin <= fechaInicio) {
					throw new Error('La fecha de fin debe ser posterior a la fecha de inicio');
				}

				return apiRequest(API_ENDPOINTS.producciones, {
					method: "POST",
					body: JSON.stringify(produccionData),
				});
			}

			async function updateProduccion(id, produccionData) {
				return apiRequest(`${API_ENDPOINTS.producciones}/${id}`, {
					method: "PUT",
					body: JSON.stringify(produccionData),
				});
			}

			async function deleteProduccionById(id) {
				return apiRequest(`${API_ENDPOINTS.producciones}/${id}`, {
					method: "DELETE",
				});
			}

			async function createUsoInsumo(usoInsumoData) {
				return apiRequest(API_ENDPOINTS.usoInsumos, {
					method: "POST",
					body: JSON.stringify(usoInsumoData),
				});
			}

			// Manejador del formulario
			async function handleProduccionFormSubmit(e) {
				e.preventDefault();

				try {
					if (isLoading) return;
					isLoading = true;

					const formData = new FormData(e.target);

					if (!formData.get("nombre") || !formData.get("tipo") || !formData.get("cantidad") || !formData.get("unidad")) {
						throw new Error("Por favor complete todos los campos requeridos");
					}

					const isUpdate = currentProduccion !== null;
					const produccionData = {
						nombre: formData.get("nombre"),
						tipo: formData.get("tipo"),
						cantidad: formData.get("cantidad"),
						unidad: formData.get("unidad"),
						fecha_cosecha: formData.get("fecha_cosecha"),
						descripcion: formData.get("descripcion") || "",
						estado: formData.get("estado") || "activo"
					};

					await apiRequest(
						isUpdate ? `${API_ENDPOINTS.producciones}/${currentProduccion.id}` : API_ENDPOINTS.producciones,
						{
							method: isUpdate ? "PUT" : "POST",
							body: JSON.stringify(produccionData),
						}
					);

					closeModal(produccionModal);
					showAlert(`Producción ${isUpdate ? "actualizada" : "creada"} exitosamente`, "success");
					loadProducciones();
					currentProduccion = null;
				} catch (error) {
					console.error("Form submission error:", error);
					showAlert(error.message || "Error en la operación", "error");
				} finally {
					isLoading = false;
				}
			}

			function showAlert(message, type = "info") {
				const alertDiv = document.createElement("div");
				alertDiv.className = `alert alert--${type}`;
				alertDiv.textContent = message;
				document.body.appendChild(alertDiv);

				setTimeout(() => {
					alertDiv.remove();
				}, 3000);
			}

			async function viewProduccion(id) {
				try {
					const produccion = await apiRequest(`${API_ENDPOINTS.producciones}/${id}`);
					const produccionDetails = document.getElementById("produccionDetails");

					produccionDetails.innerHTML = `
						<div class="entity-details">
							<div class="entity-details__info">
								<div class="entity-details__group">
									<label>ID:</label>
									<p>${produccion.id}</p>
								</div>
								<div class="entity-details__group">
									<label>Nombre:</label>
									<p>${produccion.nombre}</p>
								</div>
								<div class="entity-details__group">
									<label>Tipo:</label>
									<p>${produccion.tipo}</p>
								</div>
								<div class="entity-details__group">
									<label>Cantidad:</label>
									<p>${produccion.cantidad} ${produccion.unidad}</p>
								</div>
								<div class="entity-details__group">
									<label>Fecha de Cosecha:</label>
									<p>${formatDate(produccion.fecha_cosecha)}</p>
								</div>
								<div class="entity-details__group">
									<label>Estado:</label>
									<p class="status ${produccion.estado === "activo" ? "status--active" : "status--inactive"}">
										${produccion.estado}
									</p>
								</div>
								<div class="entity-details__group">
									<label>Descripción:</label>
									<p>${produccion.descripcion || 'Sin descripción'}</p>
								</div>
								<div class="entity-details__group">
									<label>Fecha de Creación:</label>
									<p>${formatDate(produccion.created_at)}</p>
								</div>
								<div class="entity-details__group">
									<label>Última Actualización:</label>
									<p>${formatDate(produccion.updated_at)}</p>
								</div>
							</div>
						</div>
						<div class="entity-details__actions">
							<button class="btn" onclick="closeModal(viewProduccionModal)">Cerrar</button>
							<button class="btn btn--primary" onclick="editProduccion('${produccion.id}')">Editar</button>
						</div>
					`;

					document.getElementById("viewProduccionModal").classList.add("modal--open");
				} catch (error) {
					console.error("Error viewing produccion:", error);
					showAlert("Error al cargar detalles de la producción", "error");
				}
			}

			async function editProduccion(id) {
				try {
					const produccion = await apiRequest(`${API_ENDPOINTS.producciones}/${id}`);
					currentProduccion = produccion;

					modalTitle.textContent = "Editar Producción";

					// Fill form with produccion data
					document.getElementById("nombre").value = produccion.nombre;
					document.getElementById("tipo").value = produccion.tipo;
					document.getElementById("cantidad").value = produccion.cantidad;
					document.getElementById("unidad").value = produccion.unidad;
					document.getElementById("fecha_cosecha").value = produccion.fecha_cosecha;
					document.getElementById("descripcion").value = produccion.descripcion || "";
					document.getElementById("estado").value = produccion.estado;

					produccionModal.classList.add("modal--open");

					const produccionForm = document.getElementById("produccionForm");
					produccionForm.onsubmit = async (e) => {
						e.preventDefault();
						if (isLoading) return;
						isLoading = true;

						try {
							const formData = new FormData(produccionForm);
							const updatedData = {
								nombre: formData.get("nombre"),
								tipo: formData.get("tipo"),
								cantidad: formData.get("cantidad"),
								unidad: formData.get("unidad"),
								fecha_cosecha: formData.get("fecha_cosecha"),
								descripcion: formData.get("descripcion"),
								estado: formData.get("estado")
							};

							await apiRequest(`${API_ENDPOINTS.producciones}/${id}`, {
								method: "PUT",
								headers: {
									"Content-Type": "application/json"
								},
								body: JSON.stringify(updatedData)
							});

							closeModal(produccionModal);
							showAlert("Producción actualizada exitosamente", "success");
							loadProducciones();
							currentProduccion = null;
						} catch (error) {
							console.error("Error updating produccion:", error);
							showAlert("Error al actualizar producción", "error");
						} finally {
							isLoading = false;
						}
					};
				} catch (error) {
					console.error("Error loading produccion for edit:", error);
					showAlert("Error al cargar datos de la producción", "error");
				}
			}

			async function toggleProduccionStatus(id) {
				try {
					const produccion = await apiRequest(`${API_ENDPOINTS.producciones}/${id}`);
					const newStatus = produccion.estado === "activo" ? "inactivo" : "activo";

					await apiRequest(`${API_ENDPOINTS.producciones}/${id}`, {
						method: "PUT",
						body: JSON.stringify({
							nombre: produccion.nombre,
							tipo: produccion.tipo,
							cantidad: produccion.cantidad,
							unidad: produccion.unidad,
							fecha_cosecha: produccion.fecha_cosecha,
							descripcion: produccion.descripcion,
							estado: newStatus
						}),
					});

					showAlert(`Producción ${newStatus === "activo" ? "activada" : "desactivada"} exitosamente`, "success");
					loadProducciones();
				} catch (error) {
					console.error("Error toggling produccion status:", error);
					showAlert("Error al cambiar estado de la producción", "error");
				}
			}

			function addActionButtonListeners() {
				const viewButtons = document.querySelectorAll(".action-btn--view");
				const editButtons = document.querySelectorAll(".action-btn--edit");
				const toggleButtons = document.querySelectorAll(".action-btn--enable, .action-btn--disable");

				viewButtons.forEach((button) => {
					button.addEventListener("click", () => viewProduccion(button.getAttribute("data-id")));
				});

				editButtons.forEach((button) => {
					button.addEventListener("click", () => editProduccion(button.getAttribute("data-id")));
				});

				toggleButtons.forEach((button) => {
					button.addEventListener("click", () => toggleProduccionStatus(button.getAttribute("data-id")));
				});
			}

			// Display producciones with pagination
			function displayProducciones(page) {
				const produccionesTableBody = document.getElementById("produccionesTableBody");
				produccionesTableBody.innerHTML = "";

				const startIndex = (page - 1) * itemsPerPage;
				const endIndex = startIndex + itemsPerPage;
				const paginatedProducciones = filteredProducciones.slice(startIndex, endIndex);

				if (paginatedProducciones.length === 0) {
					produccionesTableBody.innerHTML = `
						<tr>
							<td colspan="8" class="table__no-data">No se encontraron producciones</td>
						</tr>
					`;
					return;
				}

				paginatedProducciones.forEach((produccion) => {
					const row = document.createElement("tr");
					row.className = "table__row";
					row.innerHTML = `
						<td class="table__cell">${produccion.id}</td>
						<td class="table__cell">${produccion.nombre}</td>
						<td class="table__cell">${produccion.tipo}</td>
						<td class="table__cell">${produccion.cantidad}</td>
						<td class="table__cell">${produccion.unidad}</td>
						<td class="table__cell">${formatDate(produccion.fecha_cosecha)}</td>
						<td class="table__cell">
							<span class="status ${produccion.estado === "activo" ? "status--active" : "status--inactive"}">
								${produccion.estado}
							</span>
						</td>
						<td class="table__cell table__actions">
							<button class="action-btn action-btn--view" data-id="${produccion.id}" title="Ver detalles">
								<span class="material-icons">visibility</span>
							</button>
							<button class="action-btn action-btn--edit" data-id="${produccion.id}" title="Editar producción">
								<span class="material-icons">edit</span>
							</button>
							<button class="action-btn action-btn--insumo" data-id="${produccion.id}" title="Registrar uso de insumo">
								<span class="material-icons">inventory</span>
							</button>
							<button class="action-btn ${produccion.estado === "activo" ? "action-btn--disable" : "action-btn--enable"}" 
									data-id="${produccion.id}"
									title="${produccion.estado === "activo" ? "Deshabilitar" : "Habilitar"} producción">
								<span class="material-icons">${produccion.estado === "activo" ? "block" : "check_circle"}</span>
							</button>
						</td>
					`;
					produccionesTableBody.appendChild(row);
				});
				setupPagination(filteredProducciones.length);
				addActionButtonListeners();
			}

			// Setup pagination
			function setupPagination(totalItems) {
				const pagination = document.getElementById("pagination");
				const totalPages = Math.ceil(totalItems / itemsPerPage);
				pagination.innerHTML = "";

				if (totalPages <= 1) return;

				// Previous button
				const prevBtn = document.createElement("button");
				prevBtn.className = `pagination__btn ${currentPage === 1 ? "pagination__btn--disabled" : ""}`;
				prevBtn.textContent = "Anterior";
				prevBtn.disabled = currentPage === 1;
				prevBtn.addEventListener("click", () => {
					if (currentPage > 1) {
						currentPage--;
						displayProducciones(currentPage);
						setupPagination(totalItems);
					}
				});
				pagination.appendChild(prevBtn);

				// Page buttons
				const maxButtons = 5;
				let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
				let endPage = Math.min(totalPages, startPage + maxButtons - 1);

				if (endPage - startPage + 1 < maxButtons) {
					startPage = Math.max(1, endPage - maxButtons + 1);
				}

				for (let i = startPage; i <= endPage; i++) {
					const pageBtn = document.createElement("button");
					pageBtn.className = `pagination__btn ${i === currentPage ? "pagination__btn--active" : ""}`;
					pageBtn.textContent = i;
					pageBtn.addEventListener("click", () => {
						currentPage = i;
						displayProducciones(currentPage);
						setupPagination(totalItems);
					});
					pagination.appendChild(pageBtn);
				}

				// Next button
				const nextBtn = document.createElement("button");
				nextBtn.className = `pagination__btn ${currentPage === totalPages ? "pagination__btn--disabled" : ""}`;
				nextBtn.textContent = "Siguiente";
				nextBtn.disabled = currentPage === totalPages;
				nextBtn.addEventListener("click", () => {
					if (currentPage < totalPages) {
						currentPage++;
						displayProducciones(currentPage);
						setupPagination(totalItems);
					}
				});
				pagination.appendChild(nextBtn);
			}

			// Load producciones
			async function loadProducciones() {
				try {
					const producciones = await apiRequest(API_ENDPOINTS.producciones);
					filteredProducciones = producciones;
					currentPage = 1;
					displayProducciones(currentPage);
				} catch (error) {
					console.error("Error loading producciones:", error);
					document.getElementById("produccionesTableBody").innerHTML = `
						<tr>
							<td colspan="8" class="table__no-data">Error al cargar las producciones</td>
						</tr>
					`;
				}
			}

			// Report generation functions
			async function generateProduccionReport() {
				const statusFilter = document.getElementById("reportStatusSelect").value;
				const typeFilter = document.getElementById("reportTypeSelect").value;

				try {
					const producciones = await apiRequest(API_ENDPOINTS.producciones);

					const filteredData = producciones.filter(item => {
						const matchesStatus = !statusFilter || item.estado === statusFilter;
						const matchesType = !typeFilter || item.tipo === typeFilter;
						return matchesStatus && matchesType;
					});

					if (filteredData.length === 0) {
						showAlert("No hay datos para generar el reporte", "warning");
						return;
					}

					// Update report data structure
					reportData = filteredData.map(item => ({
						id: item.id,
						nombre: item.nombre,
						tipo: item.tipo,
						cantidad: item.cantidad,
						unidad: item.unidad,
						fecha_cosecha: formatDate(item.fecha_cosecha),
						estado: item.estado,
						descripcion: item.descripcion || 'Sin descripción'
					}));

					// Update summary
					const totalProducciones = reportData.length;
					const produccionesActivas = reportData.filter(item => item.estado === "activo").length;
					const produccionesInactivas = totalProducciones - produccionesActivas;
					const totalCantidad = reportData.reduce((sum, item) => sum + parseFloat(item.cantidad), 0);

					document.getElementById("totalProducciones").textContent = totalProducciones;
					document.getElementById("produccionesActivas").textContent = produccionesActivas;
					document.getElementById("produccionesInactivas").textContent = produccionesInactivas;
					document.getElementById("totalCantidad").textContent = totalCantidad.toFixed(2);

					showAlert("Reporte generado exitosamente", "success");
				} catch (error) {
					console.error("Error generating produccion report:", error);
					showAlert("Error al generar reporte de producciones", "error");
				}
			}

			function exportReportToExcel() {
				try {
					if (!reportData || reportData.length === 0) {
						showAlert("Primero debe generar el reporte", "warning");
						return;
					}

					const data = reportData.map(item => ({
						ID: item.id,
						Nombre: item.nombre,
						Tipo: item.tipo,
						Cantidad: item.cantidad,
						Unidad: item.unidad,
						"Fecha Cosecha": item.fecha_cosecha,
						Estado: item.estado,
						Descripción: item.descripcion
					}));

					if (exportToExcel(data, "Reporte_Producciones")) {
						showAlert("Reporte exportado exitosamente", "success");
					}
				} catch (error) {
					console.error("Error al exportar:", error);
					showAlert("Error al exportar el reporte", "error");
				}
			}

			function exportReportToPdf() {
				try {
					if (!reportData || reportData.length === 0) {
						showAlert("Primero debe generar el reporte", "warning");
						return;
					}

					const columns = [
						{ header: "ID", key: "id" },
						{ header: "Nombre", key: "nombre" },
						{ header: "Tipo", key: "tipo" },
						{ header: "Cantidad", key: "cantidad" },
						{ header: "Unidad", key: "unidad" },
						{ header: "Fecha Cosecha", key: "fecha_cosecha" },
						{ header: "Estado", key: "estado" },
						{ header: "Descripción", key: "descripcion" }
					];

					if (exportToPDF(reportData, columns, "Reporte_Producciones")) {
						showAlert("Reporte exportado exitosamente", "success");
					}
				} catch (error) {
					console.error("Error al exportar:", error);
					showAlert("Error al exportar el reporte", "error");
				}
			}

			// Initialize page
			document.addEventListener("DOMContentLoaded", async () => {
				await loadSelectorsData();
				initProduccionesPage();
			});

			function initProduccionesPage() {
				// DOM elements
				const searchInput = document.getElementById("searchInput");
				const filterStatus = document.getElementById("filterStatus");
				const filterType = document.getElementById("filterType");
				const applyFilterBtn = document.getElementById("applyFilterBtn");
				const resetFilterBtn = document.getElementById("resetFilterBtn");
				const newProduccionBtn = document.getElementById("newProduccionBtn");
				const generateReportBtn = document.getElementById("generateReportBtn");

				// Modal elements setup and event listeners
				const produccionModal = document.getElementById("produccionModal");
				const viewProduccionModal = document.getElementById("viewProduccionModal");
				const produccionReportModal = document.getElementById("produccionReportModal");
				const modalTitle = document.getElementById("modalTitle");
				const produccionForm = document.getElementById("produccionForm");
				const modalCloses = document.querySelectorAll(".modal__close");
				const modalCancel = produccionModal.querySelector(".modal__cancel");

				// Add close functionality to all modals
				modalCloses.forEach(closeBtn => {
					closeBtn.addEventListener("click", () => {
						currentProduccion = null;
						produccionForm.reset();
						closeModal(closeBtn.closest(".modal"));
					});
				});

				// Initial load
				loadProducciones();

				// Update displayProducciones to add action listeners after rendering
				const originalDisplayProducciones = displayProducciones;
				displayProducciones = function(page) {
					originalDisplayProducciones(page);
					addActionButtonListeners();
				};

				// Función para agregar listeners a los botones de acción
				function addActionButtonListeners() {
					// Botones de editar
					document.querySelectorAll('.action-btn--edit').forEach(btn => {
						btn.addEventListener('click', (e) => {
							const id = e.currentTarget.dataset.id;
							editProduccion(id);
						});
					});

					// Botones de uso de insumos
					document.querySelectorAll('.action-btn--insumo').forEach(btn => {
						btn.addEventListener('click', (e) => {
							const id = e.currentTarget.dataset.id;
							openUsoInsumoModal(id);
						});
					});

					// Botones de habilitar/deshabilitar
					document.querySelectorAll('.action-btn--disable, .action-btn--enable').forEach(btn => {
						btn.addEventListener('click', (e) => {
							const id = e.currentTarget.dataset.id;
							toggleProduccionStatus(id);
						});
					});
				}

				// Función para abrir modal de uso de insumos
				function openUsoInsumoModal(produccionId) {
					currentProduccionId = produccionId;
					document.getElementById('usoInsumoModal').classList.add('modal--open');
				}

				// Apply filters
				async function applyFilters() {
					const searchTerm = searchInput.value.toLowerCase();
					const statusFilter = filterStatus.value;
					const cultivoFilter = document.getElementById('filterCultivo').value;
					const cicloFilter = document.getElementById('filterCiclo').value;
					const dateFromFilter = document.getElementById('filterDateFrom').value;
					const dateToFilter = document.getElementById('filterDateTo').value;

					try {
						const producciones = await apiRequest(API_ENDPOINTS.producciones);
						filteredProducciones = producciones.filter((produccion) => {
							const matchesSearch =
								searchTerm === "" ||
								produccion.nombre.toLowerCase().includes(searchTerm) ||
								produccion.identificador.toLowerCase().includes(searchTerm);
							
							const matchesStatus =
								statusFilter === "" || produccion.estado === statusFilter;
							
							const matchesCultivo =
								cultivoFilter === "" || produccion.cultivo === cultivoFilter;
							
							const matchesCiclo =
								cicloFilter === "" || produccion.ciclo_cultivo === cicloFilter;

							let matchesDate = true;
							if (dateFromFilter && dateToFilter) {
								const fechaInicio = new Date(produccion.fecha_inicio);
								const fromDate = new Date(dateFromFilter);
								const toDate = new Date(dateToFilter);
								matchesDate = fechaInicio >= fromDate && fechaInicio <= toDate;
							}

							return matchesSearch && matchesStatus && matchesCultivo && matchesCiclo && matchesDate;
						});

						currentPage = 1;
						displayProducciones(currentPage);
						setupPagination(filteredProducciones.length);
					} catch (error) {
						console.error("Error applying filters:", error);
						showAlert("Error al aplicar filtros", "error");
					}
				}

				// Reset filters
				function resetFilters() {
					searchInput.value = "";
					filterStatus.value = "";
					document.getElementById('filterCultivo').value = "";
					document.getElementById('filterCiclo').value = "";
					document.getElementById('filterDateFrom').value = "";
					document.getElementById('filterDateTo').value = "";
					loadProducciones();
				}

				// Event listeners for filters
				applyFilterBtn.addEventListener("click", applyFilters);
				resetFilterBtn.addEventListener("click", resetFilters);
				searchInput.addEventListener("keyup", applyFilters);
				filterStatus.addEventListener("change", applyFilters);
				document.getElementById('filterCultivo').addEventListener("change", applyFilters);
				document.getElementById('filterCiclo').addEventListener("change", applyFilters);
				document.getElementById('filterDateFrom').addEventListener("change", applyFilters);
				document.getElementById('filterDateTo').addEventListener("change", applyFilters);

				// Event listeners
				modalCancel.addEventListener("click", () => closeModal(produccionModal));
				produccionForm.addEventListener("submit", handleProduccionFormSubmit);
				
				// Modal de uso de insumos
				const usoInsumoModal = document.getElementById('usoInsumoModal');
				const usoInsumoForm = document.getElementById('usoInsumoForm');
				const usoInsumoModalClose = usoInsumoModal.querySelector('.modal__close');
				const usoInsumoModalCancel = usoInsumoModal.querySelector('.modal__cancel');

				usoInsumoModalClose.addEventListener("click", () => {
					usoInsumoForm.reset();
					closeModal(usoInsumoModal);
				});

				usoInsumoModalCancel.addEventListener("click", () => {
					usoInsumoForm.reset();
					closeModal(usoInsumoModal);
				});

				usoInsumoForm.addEventListener("submit", handleUsoInsumoFormSubmit);
				
				// Calcular automáticamente el valor total
				document.getElementById('cantidad_uso').addEventListener('input', calculateTotal);
				document.getElementById('valor_unitario_uso').addEventListener('input', calculateTotal);
				
				function calculateTotal() {
					const cantidad = parseFloat(document.getElementById('cantidad_uso').value) || 0;
					const valorUnitario = parseFloat(document.getElementById('valor_unitario_uso').value) || 0;
					const valorTotal = cantidad * valorUnitario;
					document.getElementById('valor_total_uso').value = valorTotal.toFixed(2);
				}
				
				// Función para manejar el formulario de uso de insumos
				async function handleUsoInsumoFormSubmit(event) {
					event.preventDefault();
					
					const formData = new FormData(usoInsumoForm);
					const usoInsumoData = {
						produccion_id: currentProduccionId,
						insumo_id: formData.get('insumo_uso'),
						fecha_uso: formData.get('fecha_uso'),
						cantidad: parseFloat(formData.get('cantidad_uso')),
						responsable_id: formData.get('responsable_uso'),
						valor_unitario: parseFloat(formData.get('valor_unitario_uso')),
						valor_total: parseFloat(formData.get('valor_total_uso')),
						observaciones: formData.get('observaciones_uso')
					};

					try {
						await createUsoInsumo(usoInsumoData);
						showAlert('Uso de insumo registrado exitosamente', 'success');
						usoInsumoForm.reset();
						closeModal(usoInsumoModal);
					} catch (error) {
						console.error('Error creating uso insumo:', error);
						showAlert('Error al registrar uso de insumo', 'error');
					}
				}
				
				// Botón guardar borrador
				document.getElementById('saveDraftBtn').addEventListener("click", () => {
					handleProduccionFormSubmit(new Event('submit'), true); // true = es borrador
				});

				// Validación en tiempo real del formulario
				const formInputs = produccionForm.querySelectorAll('input, select, textarea');
				formInputs.forEach(input => {
					input.addEventListener('input', validateForm);
					input.addEventListener('change', validateForm);
				});

				// Función de validación del formulario
				function validateForm() {
					const nombre = document.getElementById('nombre').value;
					const responsable = document.getElementById('responsable').value;
					const cultivo = document.getElementById('cultivo').value;
					const cicloCultivo = document.getElementById('ciclo_cultivo').value;
					const sensores = Array.from(document.getElementById('sensores').selectedOptions).map(opt => opt.value);
					const insumos = Array.from(document.getElementById('insumos').selectedOptions).map(opt => opt.value);
					const fechaInicio = document.getElementById('fecha_inicio').value;
					const fechaFin = document.getElementById('fecha_fin').value;

					const isValid = nombre && responsable && cultivo && cicloCultivo && 
								   sensores.length > 0 && insumos.length > 0 && 
								   fechaInicio && fechaFin && 
								   validateProduccionName(nombre) && 
								   sensores.length <= 3 &&
								   new Date(fechaFin) > new Date(fechaInicio);

					document.getElementById('saveProduccionBtn').disabled = !isValid;
					return isValid;
				}
				newProduccionBtn.addEventListener("click", () => {
					currentProduccion = null;
					modalTitle.textContent = "Nueva Producción";
					produccionForm.reset();
					produccionModal.classList.add("modal--open");
				});

				generateReportBtn.addEventListener("click", () => {
					produccionReportModal.classList.add("modal--open");

					// Set up report generation listeners
					document.getElementById("generateReportDataBtn").addEventListener("click", generateProduccionReport);
					document.getElementById("exportExcelBtn").addEventListener("click", exportReportToExcel);
					document.getElementById("exportPdfBtn").addEventListener("click", exportReportToPdf);
				});

				// Add close functionality for report modal
				produccionReportModal.querySelector(".modal__close").addEventListener("click", () => {
					closeModal(produccionReportModal);
				});
			}
		</script>
		<script>
		// Sidebar integration
		document.addEventListener('DOMContentLoaded', function() {
			// Cargar el sidebar.html en el contenedor
			fetch('../components/sidebar.html')
				.then(res => res.text())
				.then(html => {
					document.getElementById('sidebar-container').innerHTML = html;
					window.initSidebar && window.initSidebar(); // por si el JS lo requiere
				});
		});
		</script>
	</body>
</html>

